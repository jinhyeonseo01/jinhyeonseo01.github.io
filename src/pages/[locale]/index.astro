---
import DashboardSection from "../../components/dashboard/DashboardSection.astro";
import GitHubOverviewPanel from "../../components/dashboard/GitHubOverviewPanel.astro";
import TopStarReposStrip from "../../components/dashboard/TopStarReposStrip.astro";
import LanguageSwitcher from "../../components/common/LanguageSwitcher.astro";
import profileDataRaw from "../../data/profile.json";
import { defaultLocale, isLocale, locales, type Locale } from "../../i18n/config";
import { getMessages } from "../../i18n/messages";
import { getAllLinks, getLinksByKind } from "../../lib/registry";
import { buildLocalizedPathMap, createHubJsonLd, createSeo } from "../../lib/seo";
import type { LocalizedProfileText, ProfileData } from "../../lib/types";
import BaseLayout from "../../layouts/BaseLayout.astro";

export function getStaticPaths() {
  return locales.map((locale) => ({
    params: { locale }
  }));
}

const rawLocale = Astro.params.locale?.toLowerCase() ?? defaultLocale;
const locale: Locale = isLocale(rawLocale) ? rawLocale : defaultLocale;

const profileData = profileDataRaw as ProfileData;
const fallbackProfileText: LocalizedProfileText = profileData.texts[0] ?? {
  locale: defaultLocale,
  headline: "Builder",
  bio: "Developer profile."
};
const localizedProfile =
  profileData.texts.find((entry) => entry.locale === locale) ??
  profileData.texts.find((entry) => entry.locale === defaultLocale) ??
  fallbackProfileText;

const messages = getMessages(locale);
const githubUsername = "jinhyeonseo01";
const mainLinks = getLinksByKind("main");
const apiLinks = getLinksByKind("api");
const allLinks = getAllLinks();
const embeddedApiCount = apiLinks.filter((item) => item.embedType === "iframe").length;

const site = Astro.site?.toString() ?? "https://jinhyeonseo01.github.io";
const seo = createSeo({
  site,
  locale,
  title: `${messages.siteName} | ${messages.heroEyebrow}`,
  description: messages.heroDescription,
  image: "/og/dashboard.svg",
  pathByLocale: buildLocalizedPathMap((entry) => `/${entry}/`),
  jsonLd: createHubJsonLd({
    site,
    locale,
    links: allLinks
  })
});
---

<BaseLayout locale={locale} seo={seo} pageClass="page-dashboard">
  <main class="page-shell">
    <div class="container">
      <header class="topbar">
        <div class="brand-mark">
          <strong>{messages.siteName}</strong>
          <span class="brand-mark__mode">{messages.heroEyebrow}</span>
        </div>
        <div class="topbar__controls">
          <a href={`/${locale}/apis/`} class="btn btn--secondary">
            {messages.openApiDashboard}
          </a>
          <LanguageSwitcher locale={locale} pathname={Astro.url.pathname} />
        </div>
      </header>

      <section class="system-grid">
        <aside class="system-side">
          <section class="hero panel">
            <p class="hero__eyebrow">{messages.heroEyebrow}</p>
            <h1 class="hero__title">{messages.heroTitle}</h1>
            <p class="hero__description">{messages.heroDescription}</p>

            <div class="profile-chip">
              <span class="profile-chip__emoji" aria-hidden="true">
                {profileData.avatarEmoji}
              </span>
              <div class="profile-chip__text">
                <span class="profile-chip__name">{profileData.name}</span>
                <span class="profile-chip__meta">
                  {profileData.role} Â· {profileData.location}
                </span>
                <span class="profile-chip__headline">{localizedProfile.headline}</span>
              </div>
            </div>
          </section>

          <section class="panel monitor-panel">
            <h2 class="panel__title">{messages.systemOverview}</h2>
            <div class="monitor-grid">
              <div class="metric-box">
                <span class="metric-box__label">{messages.metricMainChannels}</span>
                <strong class="metric-box__value">{mainLinks.length}</strong>
              </div>
              <div class="metric-box">
                <span class="metric-box__label">{messages.metricProjects}</span>
                <strong class="metric-box__value" data-gh-shared-metric="repos" data-username={githubUsername}>
                  --
                </strong>
              </div>
              <div class="metric-box">
                <span class="metric-box__label">{messages.metricApis}</span>
                <strong class="metric-box__value">{apiLinks.length}</strong>
              </div>
              <div class="metric-box">
                <span class="metric-box__label">{messages.metricLocales}</span>
                <strong class="metric-box__value">{locales.length}</strong>
              </div>
            </div>
          </section>

          <section class="panel api-panel">
            <h2 class="panel__title">{messages.apiDashboard}</h2>
            <p class="panel__description">{messages.apiDashboardDescription}</p>
            <div class="api-panel__status">
              <span class="api-status-dot" aria-hidden="true"></span>
              <span>{messages.statusNominal}</span>
            </div>
            <div class="api-panel__meta">
              <span>{messages.apiTotalLabel}: {apiLinks.length}</span>
              <span>{messages.apiEmbeddedLabel}: {embeddedApiCount}</span>
              <span>{messages.apiExternalLabel}: {apiLinks.length - embeddedApiCount}</span>
            </div>
            <a href={`/${locale}/apis/`} class="btn btn--primary">
              {messages.openApiDashboard}
            </a>
          </section>
        </aside>

        <div class="system-main">
          <GitHubOverviewPanel locale={locale} username={githubUsername} messages={messages} />

          <div class="section-stack">
            <DashboardSection
              locale={locale}
              title={messages.sectionMainTitle}
              description={messages.sectionMainDescription}
              items={mainLinks}
            />
            <TopStarReposStrip locale={locale} username={githubUsername} messages={messages} />
            <DashboardSection
              locale={locale}
              title={messages.sectionApiTitle}
              description={messages.sectionApiDescription}
              items={apiLinks}
            />
          </div>
        </div>
      </section>
    </div>
  </main>
</BaseLayout>
