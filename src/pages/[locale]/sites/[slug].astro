---
import LanguageSwitcher from "../../../components/common/LanguageSwitcher.astro";
import { defaultLocale, isLocale, locales, type Locale } from "../../../i18n/config";
import { getMessages } from "../../../i18n/messages";
import { getLocalizedText, getSiteLinks } from "../../../lib/registry";
import { buildLocalizedPathMap, createDetailJsonLd, createSeo } from "../../../lib/seo";
import type { LinkRegistryItem } from "../../../lib/types";
import BaseLayout from "../../../layouts/BaseLayout.astro";

export function getStaticPaths() {
  const links = getSiteLinks();
  return locales.flatMap((locale) =>
    links.map((item) => ({
      params: {
        locale,
        slug: item.slug
      },
      props: {
        item
      }
    }))
  );
}

const rawLocale = Astro.params.locale?.toLowerCase() ?? defaultLocale;
const locale: Locale = isLocale(rawLocale) ? rawLocale : defaultLocale;
const item = Astro.props.item as LinkRegistryItem;
const messages = getMessages(locale);
const text = getLocalizedText(item, locale);

const site = Astro.site?.toString() ?? "https://jinhyeonseo01.github.io";
const seo = createSeo({
  site,
  locale,
  title: `${text.title} | ${messages.detailForSite}`,
  description: text.summary,
  pathByLocale: buildLocalizedPathMap((entry) => `/${entry}/sites/${item.slug}/`),
  jsonLd: createDetailJsonLd({
    site,
    locale,
    item
  })
});
---

<BaseLayout locale={locale} seo={seo}>
  <main class="page-shell">
    <div class="container stack">
      <header class="topbar">
        <a href={`/${locale}/`} class="btn btn--secondary">
          {messages.backToDashboard}
        </a>
        <LanguageSwitcher locale={locale} pathname={Astro.url.pathname} />
      </header>

      <section class="detail-panel">
        <p class="detail-panel__meta">{messages.detailForSite}</p>
        <h1 class="detail-panel__title">{text.title}</h1>
        <p class="detail-panel__description">{text.summary}</p>

        <p class="detail-panel__meta">{messages.externalTransition}</p>
        <div class="link-card__actions">
          <a class="btn btn--primary" href={`/go/${item.slug}/`}>
            {messages.openViaGo}
          </a>
          <a class="btn btn--secondary" href={item.href}>
            {messages.openNow}
          </a>
        </div>

        {
          item.embedType === "iframe" && item.embedSrc && (
            <iframe class="detail-panel__iframe" loading="lazy" src={item.embedSrc} />
          )
        }
      </section>
    </div>
  </main>
</BaseLayout>

